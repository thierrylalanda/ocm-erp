import{a as J}from"./chunk-H5RQM42I.js";import{b as q}from"./chunk-27KQ6NAF.js";import{c as Y}from"./chunk-6P5VJYPL.js";import"./chunk-VLYMLFWW.js";import{c as X,f as H}from"./chunk-5IGNUQZL.js";import"./chunk-G64D4X4E.js";import{a as K,c as z}from"./chunk-HOOCBFFS.js";import{k as $,l as L,v as j,y as G}from"./chunk-E22WOTPK.js";import{$b as I,Ic as V,Kb as D,Qc as k,Rb as m,Sb as r,Sc as d,Tb as a,Tc as c,Ub as v,Yb as y,Zb as T,fc as C,ha as M,hb as n,hc as p,ka as R,ma as h,ra as x,sa as E,tc as w,ub as U,wc as l,xc as _,yc as b,zb as f,zc as F}from"./chunk-RKWTZGMB.js";import"./chunk-EQDQRRRY.js";var N=(P=>(P.CREATE="CREATE",P.READ="READ",P.UPDATE="UPDATE",P.DELETE="DELETE",P.EXPORT="EXPORT",P.IMPORT="IMPORT",P.PRINT="PRINT",P))(N||{});var B=new R("GET_PERMISSIONS_USE_CASE");var S=new R("PERMISSION_REPOSITORY");var A=class t{permissionRepository=h(S);execute(i=0,e=100){return this.permissionRepository.getAllPermissions(i,e)}static \u0275fac=function(e){return new(e||t)};static \u0275prov=M({token:t,factory:t.\u0275fac})};var O=class t{http=h(z);baseUrl=`${J.api}security`;getAllPermissions(i=0,e=100){let s=new K().set("page",i.toString()).set("size",e.toString());return this.http.get(`${this.baseUrl}/permissions`,{params:s})}getRolePermissions(i){return this.http.get(`${this.baseUrl}/roles/${i}/permissions`)}assignPermissionToRole(i,e){return this.http.post(`${this.baseUrl}/roles/${i}/permissions`,e)}removePermissionFromRole(i,e){return this.http.delete(`${this.baseUrl}/roles/${i}/permissions/${e}`)}assignPermissionsBatch(i,e){let s={permissionIds:e};return this.http.post(`${this.baseUrl}/roles/${i}/permissions/batch`,s)}static \u0275fac=function(e){return new(e||t)};static \u0275prov=M({token:t,factory:t.\u0275fac})};var Z=(t,i,e,s,o,u,g)=>[t,i,e,s,o,u,g];function ie(t,i){if(t&1){let e=I();r(0,"div",16),v(1,"i",17),l(2),d(3,"translate"),r(4,"button",18),C("click",function(){x(e);let o=p();return E(o.dismissSaveSuccess())}),a()()}t&2&&(n(2),b(" ",c(3,1,"permissions.permissionManagement.saveSuccess")," "))}function te(t,i){if(t&1){let e=I();r(0,"div",19),v(1,"i",20),l(2),r(3,"button",18),C("click",function(){x(e);let o=p();return E(o.dismissSaveError())}),a()()}if(t&2){let e=p();n(2),b(" ",e.saveError," ")}}function se(t,i){t&1&&(r(0,"div",21)(1,"div",22)(2,"span",23),l(3,"Loading..."),a()(),r(4,"p",24),l(5),d(6,"translate"),a()()),t&2&&(n(5),_(c(6,1,"permissions.permissionManagement.loading")))}function ne(t,i){if(t&1){let e=I();r(0,"div",25),v(1,"i",20),l(2),r(3,"button",26),C("click",function(){x(e);let o=p();return E(o.loadData())}),l(4),d(5,"translate"),a()()}if(t&2){let e=p();n(2),b(" ",e.error," "),n(2),_(c(5,2,"permissions.permissionManagement.retry"))}}function oe(t,i){t&1&&v(0,"span",31)}function re(t,i){t&1&&v(0,"i",32)}function ae(t,i){if(t&1){let e=I();r(0,"div",27)(1,"button",28),C("click",function(){x(e);let o=p();return E(o.savePermissions())}),f(2,oe,1,0,"span",29)(3,re,1,0,"i",30),l(4),d(5,"translate"),d(6,"translate"),a()()}if(t&2){let e=p();n(),m("disabled",!e.hasChanges()||e.saving),n(),m("ngIf",e.saving),n(),m("ngIf",!e.saving),n(),b(" ",e.saving?c(5,4,"permissions.permissionManagement.saving"):c(6,6,"permissions.permissionManagement.saveButton")," ")}}function me(t,i){if(t&1&&(r(0,"th"),l(1),d(2,"translate"),a()),t&2){let e=i.$implicit,s=p(3);n(),b(" ",c(2,1,s.getActionDisplayName(e))," ")}}function le(t,i){if(t&1){let e=I();r(0,"div",48)(1,"input",51),C("change",function(o){let u=x(e).$implicit,g=p(6);return E(g.onPermissionChange(u.id,o))}),a()()}if(t&2){let e=i.$implicit,s=p(6);n(),m("id","permission-"+e.id)("checked",s.isPermissionAssigned(e.id))}}function pe(t,i){if(t&1&&(y(0),f(1,le,2,2,"div",50),T()),t&2){let e=p().$implicit,s=p().$implicit;n(),m("ngForOf",s.value.get(e))}}function de(t,i){t&1&&(y(0),r(1,"div",48),v(2,"input",52),a(),T())}function ce(t,i){if(t&1&&(r(0,"td"),f(1,pe,2,1,"ng-container",47)(2,de,3,0,"ng-container",47),a()),t&2){let e=i.$implicit,s=p().$implicit;n(),m("ngIf",s.value.has(e)),n(),m("ngIf",!s.value.has(e))}}function ue(t,i){if(t&1){let e=I();y(0),r(1,"tr")(2,"td"),l(3),a(),f(4,ce,3,2,"td",46),r(5,"td")(6,"div",48)(7,"input",49),C("change",function(o){let u=x(e).$implicit,g=p(3);return E(g.toggleAllPermissionsForSubModule(u.value,o))}),a()()()(),T()}if(t&2){let e=i.$implicit,s=p(3);n(3),_(e.key),n(),m("ngForOf",k(3,Z,s.PermissionAction.CREATE,s.PermissionAction.READ,s.PermissionAction.UPDATE,s.PermissionAction.DELETE,s.PermissionAction.EXPORT,s.PermissionAction.IMPORT,s.PermissionAction.PRINT)),n(3),m("checked",s.isAllPermissionsAssignedForSubModule(e.value))}}function ge(t,i){t&1&&(r(0,"tr")(1,"td",53),v(2,"i",54),r(3,"p",55),l(4),d(5,"translate"),a()()()),t&2&&(n(4),_(c(5,1,"permissions.permissionManagement.noModulePermissions")))}function Pe(t,i){if(t&1&&(r(0,"div",36)(1,"h2",37)(2,"button",38)(3,"span",39),l(4),d(5,"translate"),a()()(),r(6,"div",40)(7,"div",41)(8,"div",42)(9,"table",43)(10,"thead",44)(11,"tr")(12,"th",45),l(13),d(14,"translate"),a(),f(15,me,3,3,"th",46),r(16,"th"),l(17),d(18,"translate"),a()()(),r(19,"tbody"),f(20,ue,8,11,"ng-container",46),d(21,"keyvalue"),f(22,ge,6,3,"tr",47),a()()()()()()),t&2){let e=i.$implicit,s=i.index,o=p(2);n(),m("id","heading"+s),n(),w("collapsed",s!==0),D("data-bs-target","#collapse"+s)("aria-expanded",s===0?"true":"false")("aria-controls","collapse"+s),n(2),_(c(5,16,o.getModuleDisplayName(e))),n(2),w("show",s===0),m("id","collapse"+s),D("aria-labelledby","heading"+s),n(7),_(c(14,18,"permissions.permissionManagement.subModule")),n(2),m("ngForOf",k(24,Z,o.PermissionAction.CREATE,o.PermissionAction.READ,o.PermissionAction.UPDATE,o.PermissionAction.DELETE,o.PermissionAction.EXPORT,o.PermissionAction.IMPORT,o.PermissionAction.PRINT)),n(2),_(c(18,20,"permissions.permissionManagement.allowAll")),n(3),m("ngForOf",c(21,22,o.getPermissionsBySubModule(e))),n(2),m("ngIf",o.getPermissionsBySubModule(e).size===0)}}function _e(t,i){t&1&&(r(0,"div",21),v(1,"i",56),r(2,"h5",57),l(3),d(4,"translate"),a(),r(5,"p",55),l(6),d(7,"translate"),a()()),t&2&&(n(3),_(c(4,2,"permissions.permissionManagement.noPermissions")),n(3),_(c(7,4,"permissions.permissionManagement.noPermissionsMessage")))}function fe(t,i){if(t&1&&(r(0,"div",33)(1,"div",34),f(2,Pe,23,32,"div",35)(3,_e,8,6,"div",12),a()()),t&2){let e=p();n(2),m("ngForOf",e.getAvailableModules()),n(),m("ngIf",e.getAvailableModules().length===0&&!e.loading)}}var W=class t{route=h(X);getPermissionsUseCase=h(B);permissionRepository=h(S);roleId=null;roleCode="";roleNom="";allPermissions=[];rolePermissions=new Set;selectedPermissions=new Set;loading=!1;saving=!1;error=null;saveSuccess=!1;saveError=null;groupedPermissions=new Map;routes=Y;PermissionAction=N;ngOnInit(){this.loadRoleId(),this.loadData()}loadRoleId(){this.route.paramMap.subscribe(i=>{let e=i.get("roleId");this.roleId=e?parseInt(e,10):null})}loadData(){if(!this.roleId){this.error="ID du r\xF4le non sp\xE9cifi\xE9";return}this.loading=!0,this.error=null,this.permissionRepository.getRolePermissions(this.roleId).subscribe({next:i=>{this.roleCode=i.roleCode,this.roleNom=i.roleNom,this.rolePermissions=new Set(i.permissions.map(e=>e.permissionId)),this.selectedPermissions=new Set(this.rolePermissions),this.loadAllPermissions()},error:i=>{console.error("Erreur lors du chargement des permissions du r\xF4le:",i),this.error="Erreur lors du chargement des permissions du r\xF4le",this.loading=!1}})}loadAllPermissions(){this.getPermissionsUseCase.execute().subscribe({next:i=>{this.allPermissions=i.content||[],this.groupPermissionsByModule(),this.loading=!1},error:i=>{console.error("Erreur lors du chargement des permissions:",i),this.error="Erreur lors du chargement des permissions",this.loading=!1}})}groupPermissionsByModule(){this.groupedPermissions.clear(),this.allPermissions.forEach(i=>{let e=i.permModule;this.groupedPermissions.has(e)||this.groupedPermissions.set(e,[]),this.groupedPermissions.get(e).push(i)})}getSubModuleFromPermissionCode(i){let e=i.split(":");return e.length>=2?e[1]:i}getActionFromPermissionCode(i){let e=i.split(":");return e.length>=3?e[2]:i}getPermissionsBySubModule(i){let e=new Map;return this.getPermissionsByModule(i).forEach(o=>{let u=this.getSubModuleFromPermissionCode(o.permCode);e.has(u)||e.set(u,new Map);let g=e.get(u),P=o.permAction;g.has(P)||g.set(P,[]),g.get(P).push(o)}),e}getAvailableActionsForSubModule(i){return Array.from(i.keys())}isPermissionAssigned(i){return this.selectedPermissions.has(i)}hasChanges(){if(this.rolePermissions.size!==this.selectedPermissions.size)return!0;for(let i of this.rolePermissions)if(!this.selectedPermissions.has(i))return!0;for(let i of this.selectedPermissions)if(!this.rolePermissions.has(i))return!0;return!1}onPermissionChange(i,e){e.target.checked?this.selectedPermissions.add(i):this.selectedPermissions.delete(i)}savePermissions(){if(!this.roleId||!this.hasChanges())return;this.saving=!0,this.saveError=null,this.saveSuccess=!1;let i=Array.from(this.selectedPermissions);this.permissionRepository.assignPermissionsBatch(this.roleId,i).subscribe({next:e=>{this.rolePermissions=new Set(this.selectedPermissions),e.roleCode&&(this.roleCode=e.roleCode,this.roleNom=e.roleNom),this.saveSuccess=!0,this.saving=!1,setTimeout(()=>{this.loadData()},2e3)},error:e=>{console.error("Erreur lors de l'enregistrement des permissions:",e),this.saveError=e.message||"Erreur lors de l'enregistrement des permissions",this.saving=!1}})}dismissSaveSuccess(){this.saveSuccess=!1}dismissSaveError(){this.saveError=null}getModuleDisplayName(i){return{CAISSE:"permissions.permissionManagement.modules.INVOICING",STOCK:"permissions.permissionManagement.modules.STOCK",PRODUCTION:"permissions.permissionManagement.modules.PRODUCTION",COMPTABILITE:"permissions.permissionManagement.modules.ACCOUNTING",APPROVISIONNEMENT:"permissions.permissionManagement.modules.STOCK"}[i]||i}getActionDisplayName(i){return{CREATE:"permissions.permissionManagement.actions.CREATE",READ:"permissions.permissionManagement.actions.READ",UPDATE:"permissions.permissionManagement.actions.UPDATE",DELETE:"permissions.permissionManagement.actions.DELETE",EXPORT:"permissions.permissionManagement.actions.EXPORT",IMPORT:"permissions.permissionManagement.actions.IMPORT",PRINT:"permissions.permissionManagement.actions.PRINT"}[i]||i}getPermissionsByModule(i){return this.groupedPermissions.get(i)||[]}getAvailableModules(){return Array.from(this.groupedPermissions.keys())}isAllPermissionsAssignedForSubModule(i){let e=!0;for(let[s,o]of i){for(let u of o)if(!this.isPermissionAssigned(u.id)){e=!1;break}if(!e)break}return e}toggleAllPermissionsForSubModule(i,e){let o=e.target.checked,u=[];for(let[g,P]of i)for(let ee of P)u.push(ee.id);o?u.forEach(g=>{this.selectedPermissions.add(g)}):u.forEach(g=>{this.selectedPermissions.delete(g)})}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=U({type:t,selectors:[["app-permission"]],features:[V([{provide:S,useClass:O},{provide:B,useClass:A},{provide:"LOCAL_STORAGE",useValue:localStorage}])],decls:27,vars:20,consts:[[1,"content-two"],[1,"d-flex","d-block","align-items-center","justify-content-between","flex-wrap","gap-3","mb-3"],[3,"routerLink"],[1,"isax","isax-arrow-left","me-1"],[1,"d-flex","my-xl-auto","right-content","align-items-center","flex-wrap","gap-2"],[1,"dropdown","me-2"],["href","javascript:void(0);","data-bs-toggle","dropdown",1,"dropdown-toggle","btn","btn-outline-white","d-inline-flex","align-items-center"],[1,"fw-normal","ms-1"],[1,"dropdown-menu","dropdown-menu-end"],["href","javascript:void(0);",1,"dropdown-item"],["class","alert alert-success alert-dismissible fade show","role","alert",4,"ngIf"],["class","alert alert-danger alert-dismissible fade show","role","alert",4,"ngIf"],["class","text-center py-5",4,"ngIf"],["class","alert alert-danger","role","alert",4,"ngIf"],["class","d-flex justify-content-end mb-3",4,"ngIf"],["class","",4,"ngIf"],["role","alert",1,"alert","alert-success","alert-dismissible","fade","show"],[1,"isax","isax-tick-circle","me-2"],["type","button","data-bs-dismiss","alert","aria-label","Close",1,"btn-close",3,"click"],["role","alert",1,"alert","alert-danger","alert-dismissible","fade","show"],[1,"isax","isax-danger","me-2"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[1,"mt-2"],["role","alert",1,"alert","alert-danger"],["type","button",1,"btn","btn-sm","btn-outline-danger","ms-2",3,"click"],[1,"d-flex","justify-content-end","mb-3"],["type","button",1,"btn","btn-primary","d-inline-flex","align-items-center",3,"click","disabled"],["class","spinner-border spinner-border-sm me-1",4,"ngIf"],["class","isax isax-save-2 me-1",4,"ngIf"],[1,"spinner-border","spinner-border-sm","me-1"],[1,"isax","isax-save-2","me-1"],[1,""],["id","permissionsAccordion",1,"accordion"],["class","accordion-item",4,"ngFor","ngForOf"],[1,"accordion-item"],[1,"accordion-header",3,"id"],["type","button","data-bs-toggle","collapse",1,"accordion-button","text-dark"],[1,"fs-18","fw-bold"],["data-bs-parent","#permissionsAccordion",1,"accordion-collapse","collapse",3,"id"],[1,"accordion-body"],[1,"table-responsive","table-nowrap"],[1,"table","border","mb-0"],[1,"table-light"],[1,"w-50"],[4,"ngFor","ngForOf"],[4,"ngIf"],[1,"form-check"],["type","checkbox",1,"form-check-input",3,"change","checked"],["class","form-check",4,"ngFor","ngForOf"],["type","checkbox",1,"form-check-input",3,"change","id","checked"],["type","checkbox","disabled","",1,"form-check-input"],["colspan","9",1,"text-center","py-4"],[1,"isax","isax-shield-slash","fs-24","text-muted","mb-2","d-block"],[1,"text-muted","mb-0"],[1,"isax","isax-shield-slash","fs-48","text-muted","mb-3","d-block"],[1,"text-muted","mb-2"]],template:function(e,s){e&1&&(r(0,"div",0)(1,"div",1)(2,"div")(3,"h6")(4,"a",2),v(5,"i",3),l(6),d(7,"translate"),a()()(),r(8,"div",4)(9,"div",5)(10,"a",6),l(11),d(12,"translate"),r(13,"span",7),l(14),d(15,"translate"),a()(),r(16,"ul",8)(17,"li")(18,"a",9),l(19),d(20,"translate"),a()()()()()(),f(21,ie,5,3,"div",10)(22,te,4,1,"div",11)(23,se,7,3,"div",12)(24,ne,6,4,"div",13)(25,ae,7,8,"div",14)(26,fe,4,2,"div",15),a()),e&2&&(n(4),m("routerLink",s.routes.rolePermissions),n(2),b(" ",c(7,12,"permissions.permissionManagement.title")," "),n(5),b(" ",c(12,14,"permissions.permissionManagement.role")," : "),n(3),_(s.roleNom||c(15,16,"permissions.permissionManagement.roleLoading")),n(5),F("",c(20,18,"permissions.permissionManagement.roleCode"),": ",s.roleCode),n(2),m("ngIf",s.saveSuccess),n(),m("ngIf",s.saveError),n(),m("ngIf",s.loading),n(),m("ngIf",s.error&&!s.loading),n(),m("ngIf",!s.loading&&!s.error),n(),m("ngIf",!s.loading&&!s.error))},dependencies:[G,$,L,H,j,q],encapsulation:2})};export{W as PermissionComponent};
