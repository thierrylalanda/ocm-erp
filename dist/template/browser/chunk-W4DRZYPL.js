import{a as q}from"./chunk-H5RQM42I.js";import{b as Y}from"./chunk-RTG4BLL2.js";import{c as X}from"./chunk-CPHVHMG6.js";import"./chunk-VLYMLFWW.js";import{c as z,f as H}from"./chunk-5IXW6HGI.js";import"./chunk-DIDBO66C.js";import{a as G,c as K}from"./chunk-DXRJN4NQ.js";import{k as $,l as F,v as L,y as j}from"./chunk-AKUYEWL4.js";import{Ab as f,Ac as V,Kc as U,Lb as B,Sb as l,Tb as o,Ub as a,Uc as c,Vb as P,Vc as u,Zb as I,_b as S,ac as M,gc as h,ia as w,ib as s,ic as p,la as T,na as E,sa as x,ta as b,uc as A,vb as N,xc as d,yc as v,zc as C}from"./chunk-ODQYRIBQ.js";import"./chunk-EQDQRRRY.js";var D=(g=>(g.CREATE="CREATE",g.READ="READ",g.UPDATE="UPDATE",g.DELETE="DELETE",g.EXPORT="EXPORT",g.IMPORT="IMPORT",g.PRINT="PRINT",g))(D||{});var k=new T("GET_PERMISSIONS_USE_CASE");var y=new T("PERMISSION_REPOSITORY");var R=class t{permissionRepository=E(y);execute(i=0,e=100){return this.permissionRepository.getAllPermissions(i,e)}static \u0275fac=function(e){return new(e||t)};static \u0275prov=w({token:t,factory:t.\u0275fac})};var O=class t{http=E(K);baseUrl=`${q.api}security`;getAllPermissions(i=0,e=100){let n=new G().set("page",i.toString()).set("size",e.toString());return this.http.get(`${this.baseUrl}/permissions`,{params:n})}getRolePermissions(i){return this.http.get(`${this.baseUrl}/roles/${i}/permissions`)}assignPermissionToRole(i,e){return this.http.post(`${this.baseUrl}/roles/${i}/permissions`,e)}removePermissionFromRole(i,e){return this.http.delete(`${this.baseUrl}/roles/${i}/permissions/${e}`)}assignPermissionsBatch(i,e){let n={permissionIds:e};return this.http.post(`${this.baseUrl}/roles/${i}/permissions/batch`,n)}static \u0275fac=function(e){return new(e||t)};static \u0275prov=w({token:t,factory:t.\u0275fac})};function ee(t,i){if(t&1){let e=M();o(0,"div",16),P(1,"i",17),d(2),c(3,"translate"),o(4,"button",18),h("click",function(){x(e);let r=p();return b(r.dismissSaveSuccess())}),a()()}t&2&&(s(2),C(" ",u(3,1,"permissions.permissionManagement.saveSuccess")," "))}function ie(t,i){if(t&1){let e=M();o(0,"div",19),P(1,"i",20),d(2),o(3,"button",18),h("click",function(){x(e);let r=p();return b(r.dismissSaveError())}),a()()}if(t&2){let e=p();s(2),C(" ",e.saveError," ")}}function te(t,i){t&1&&(o(0,"div",21)(1,"div",22)(2,"span",23),d(3,"Loading..."),a()(),o(4,"p",24),d(5),c(6,"translate"),a()()),t&2&&(s(5),v(u(6,1,"permissions.permissionManagement.loading")))}function ne(t,i){if(t&1){let e=M();o(0,"div",25),P(1,"i",20),d(2),o(3,"button",26),h("click",function(){x(e);let r=p();return b(r.loadData())}),d(4),c(5,"translate"),a()()}if(t&2){let e=p();s(2),C(" ",e.error," "),s(2),v(u(5,2,"permissions.permissionManagement.retry"))}}function se(t,i){t&1&&P(0,"span",31)}function re(t,i){t&1&&P(0,"i",32)}function oe(t,i){if(t&1){let e=M();o(0,"div",27)(1,"button",28),h("click",function(){x(e);let r=p();return b(r.savePermissions())}),f(2,se,1,0,"span",29)(3,re,1,0,"i",30),d(4),c(5,"translate"),c(6,"translate"),a()()}if(t&2){let e=p();s(),l("disabled",!e.hasChanges()||e.saving),s(),l("ngIf",e.saving),s(),l("ngIf",!e.saving),s(),C(" ",e.saving?u(5,4,"permissions.permissionManagement.saving"):u(6,6,"permissions.permissionManagement.saveButton")," ")}}function ae(t,i){if(t&1&&P(0,"i",59),t&2){let e=p().$implicit;l("title",e.permDescription),B("data-bs-toggle","popover")("data-bs-trigger","hover focus")("data-bs-placement","top")("data-bs-content",e.permDescription)}}function me(t,i){if(t&1){let e=M();I(0),o(1,"li",54)(2,"div",55)(3,"input",56),h("change",function(r){let m=x(e).$implicit,_=p(8);return b(_.onPermissionChange(m.id,r))}),a(),o(4,"label",57),d(5),a(),f(6,ae,1,5,"i",58),a()(),S()}if(t&2){let e=i.$implicit,n=p(8);s(3),l("id","permission-"+e.id)("checked",n.isPermissionAssigned(e.id)),s(),l("for","permission-"+e.id),s(),C(" ",e.permNom||e.permCode," "),s(),l("ngIf",e.permDescription)}}function le(t,i){if(t&1&&(o(0,"li",37)(1,"ul",53),f(2,me,7,5,"ng-container",35),a()()),t&2){let e=p().$implicit;s(2),l("ngForOf",e.value)}}function pe(t,i){if(t&1&&(I(0),f(1,le,3,1,"li",52),S()),t&2){let e=i.$implicit;s(),l("ngIf",e.value.length>0)}}function de(t,i){if(t&1&&(o(0,"ul",43),f(1,pe,2,1,"ng-container",35),c(2,"keyvalue"),a()),t&2){let e=p().$implicit;s(),l("ngForOf",u(2,1,e.value))}}function ce(t,i){if(t&1){let e=M();I(0),o(1,"li",37)(2,"div",45)(3,"div",46),h("click",function(){let r=x(e).index,m=p(2).index,_=p(2);return b(_.toggleSubModuleExpansion(m,r))}),P(4,"i",47),o(5,"span",48),d(6),a()(),o(7,"div",49)(8,"input",50),h("change",function(r){let m=x(e).$implicit,_=p(4);return b(_.toggleAllPermissionsForSubModule(m.value,r))}),a(),o(9,"label",51),d(10),c(11,"translate"),a()()(),f(12,de,3,3,"ul",42),a(),S()}if(t&2){let e=i.$implicit,n=i.index,r=p(2).index,m=p(2);s(4),A("rotate-90",m.isSubModuleExpanded(r,n)),s(2),v(e.key),s(2),l("checked",m.isAllPermissionsAssignedForSubModule(e.value)),s(2),C(" ",u(11,6,"permissions.permissionManagement.allowAll")," "),s(2),l("ngIf",m.isSubModuleExpanded(r,n))}}function ue(t,i){t&1&&(o(0,"li",60),P(1,"i",61),o(2,"p",62),d(3),c(4,"translate"),a()()),t&2&&(s(3),v(u(4,1,"permissions.permissionManagement.noModulePermissions")))}function ge(t,i){if(t&1&&(o(0,"ul",43),f(1,ce,13,8,"ng-container",35),c(2,"keyvalue"),f(3,ue,5,3,"li",44),a()),t&2){let e=p().$implicit,n=p(2);s(),l("ngForOf",u(2,2,n.getPermissionsBySubModule(e))),s(2),l("ngIf",n.getPermissionsBySubModule(e).size===0)}}function _e(t,i){if(t&1){let e=M();I(0),o(1,"li",37)(2,"div",38),h("click",function(){let r=x(e).index,m=p(2);return b(m.toggleModuleExpansion(r))}),P(3,"i",39),o(4,"span",40),d(5),c(6,"translate"),a(),o(7,"span",41),d(8),a()(),f(9,ge,4,4,"ul",42),a(),S()}if(t&2){let e=i.$implicit,n=i.index,r=p(2);s(3),A("rotate-90",r.isModuleExpanded(n)),s(2),v(u(6,5,r.getModuleDisplayName(e))),s(3),v(r.getPermissionsBySubModule(e).size),s(),l("ngIf",r.isModuleExpanded(n))}}function fe(t,i){t&1&&(o(0,"li",63),P(1,"i",64),o(2,"h5",65),d(3),c(4,"translate"),a(),o(5,"p",66),d(6),c(7,"translate"),a()()),t&2&&(s(3),v(u(4,2,"permissions.permissionManagement.noPermissions")),s(3),v(u(7,4,"permissions.permissionManagement.noPermissionsMessage")))}function Pe(t,i){if(t&1&&(o(0,"div",33)(1,"ul",34),f(2,_e,10,7,"ng-container",35)(3,fe,8,6,"li",36),a()()),t&2){let e=p();s(2),l("ngForOf",e.getAvailableModules()),s(),l("ngIf",e.getAvailableModules().length===0&&!e.loading)}}var Q=class t{route=E(z);getPermissionsUseCase=E(k);permissionRepository=E(y);roleId=null;roleCode="";roleNom="";allPermissions=[];rolePermissions=new Set;selectedPermissions=new Set;loading=!1;saving=!1;error=null;saveSuccess=!1;saveError=null;groupedPermissions=new Map;routes=X;PermissionAction=D;expandedModules=new Set;expandedSubModules=new Map;ngOnInit(){this.loadRoleId(),this.loadData()}loadRoleId(){this.route.paramMap.subscribe(i=>{let e=i.get("roleId");this.roleId=e?parseInt(e,10):null})}loadData(){if(!this.roleId){this.error="ID du r\xF4le non sp\xE9cifi\xE9";return}this.loading=!0,this.error=null,this.permissionRepository.getRolePermissions(this.roleId).subscribe({next:i=>{this.roleCode=i.roleCode,this.roleNom=i.roleNom,this.rolePermissions=new Set(i.permissions.map(e=>e.permissionId)),this.selectedPermissions=new Set(this.rolePermissions),this.loadAllPermissions()},error:i=>{this.error="Erreur lors du chargement des permissions du r\xF4le",this.loading=!1}})}loadAllPermissions(){this.getPermissionsUseCase.execute().subscribe({next:i=>{this.allPermissions=i.content||[],this.groupPermissionsByModule(),this.loading=!1},error:i=>{this.error="Erreur lors du chargement des permissions",this.loading=!1}})}groupPermissionsByModule(){this.groupedPermissions.clear(),this.allPermissions.forEach(i=>{let e=i.permModule;this.groupedPermissions.has(e)||this.groupedPermissions.set(e,[]),this.groupedPermissions.get(e).push(i)})}getSubModuleFromPermissionCode(i){let e=i.split(":");return e.length>=2?e[1]:i}getPermissionsBySubModule(i){let e=new Map;return this.getPermissionsByModule(i).forEach(r=>{let m=this.getSubModuleFromPermissionCode(r.permCode);e.has(m)||e.set(m,new Map);let _=e.get(m),g=r.permAction;_.has(g)||_.set(g,[]),_.get(g).push(r)}),e}isPermissionAssigned(i){return this.selectedPermissions.has(i)}hasChanges(){if(this.rolePermissions.size!==this.selectedPermissions.size)return!0;for(let i of this.rolePermissions)if(!this.selectedPermissions.has(i))return!0;for(let i of this.selectedPermissions)if(!this.rolePermissions.has(i))return!0;return!1}onPermissionChange(i,e){let r=e.target.checked,m=new Set(this.selectedPermissions);r?m.add(i):m.delete(i),this.selectedPermissions=m}savePermissions(){if(!this.roleId||!this.hasChanges())return;this.saving=!0,this.saveError=null,this.saveSuccess=!1;let i=Array.from(this.selectedPermissions);this.permissionRepository.assignPermissionsBatch(this.roleId,i).subscribe({next:e=>{this.rolePermissions=new Set(this.selectedPermissions),e.roleCode&&(this.roleCode=e.roleCode,this.roleNom=e.roleNom),this.saveSuccess=!0,this.saving=!1,setTimeout(()=>{this.loadData()},2e3)},error:e=>{this.saveError=e.message||"Erreur lors de l'enregistrement des permissions",this.saving=!1}})}dismissSaveSuccess(){this.saveSuccess=!1}dismissSaveError(){this.saveError=null}getModuleDisplayName(i){return{CAISSE:"permissions.permissionManagement.modules.INVOICING",STOCK:"permissions.permissionManagement.modules.STOCK",PRODUCTION:"permissions.permissionManagement.modules.PRODUCTION",COMPTABILITE:"permissions.permissionManagement.modules.ACCOUNTING",APPROVISIONNEMENT:"permissions.permissionManagement.modules.STOCK"}[i]||i}getActionDisplayName(i){return{CREATE:"permissions.permissionManagement.actions.CREATE",READ:"permissions.permissionManagement.actions.READ",UPDATE:"permissions.permissionManagement.actions.UPDATE",DELETE:"permissions.permissionManagement.actions.DELETE",EXPORT:"permissions.permissionManagement.actions.EXPORT",IMPORT:"permissions.permissionManagement.actions.IMPORT",PRINT:"permissions.permissionManagement.actions.PRINT"}[i]||i}getPermissionsByModule(i){return this.groupedPermissions.get(i)||[]}getAvailableModules(){return Array.from(this.groupedPermissions.keys())}isAllPermissionsAssignedForSubModule(i){let e=!0;for(let[n,r]of i){for(let m of r)if(!this.isPermissionAssigned(m.id)){e=!1;break}if(!e)break}return e}toggleAllPermissionsForSubModule(i,e){let r=e.target.checked,m=[];for(let[g,W]of i)for(let Z of W)m.push(Z.id);let _=new Set(this.selectedPermissions);r?m.forEach(g=>{_.add(g)}):m.forEach(g=>{_.delete(g)}),this.selectedPermissions=_}toggleModuleExpansion(i){this.expandedModules.has(i)?this.expandedModules.delete(i):this.expandedModules.add(i)}isModuleExpanded(i){return this.expandedModules.has(i)}toggleSubModuleExpansion(i,e){this.expandedSubModules.has(i)||this.expandedSubModules.set(i,new Set);let n=this.expandedSubModules.get(i);n.has(e)?n.delete(e):n.add(e)}isSubModuleExpanded(i,e){let n=this.expandedSubModules.get(i);return n?n.has(e):!1}getActionDescription(i){return{CREATE:"Permet de cr\xE9er de nouveaux \xE9l\xE9ments",READ:"Permet de visualiser les \xE9l\xE9ments",UPDATE:"Permet de modifier les \xE9l\xE9ments existants",DELETE:"Permet de supprimer des \xE9l\xE9ments",EXPORT:"Permet d'exporter des donn\xE9es",IMPORT:"Permet d'importer des donn\xE9es",PRINT:"Permet d'imprimer des documents"}[i]||"Aucune description disponible"}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=N({type:t,selectors:[["app-permission"]],features:[U([{provide:y,useClass:O},{provide:k,useClass:R},{provide:"LOCAL_STORAGE",useValue:localStorage}])],decls:27,vars:20,consts:[[1,"content-two"],[1,"d-flex","d-block","align-items-center","justify-content-between","flex-wrap","gap-3","mb-3"],[3,"routerLink"],[1,"isax","isax-arrow-left","me-1"],[1,"d-flex","my-xl-auto","right-content","align-items-center","flex-wrap","gap-2"],[1,"dropdown","me-2"],["href","javascript:void(0);","data-bs-toggle","dropdown",1,"dropdown-toggle","btn","btn-outline-white","d-inline-flex","align-items-center"],[1,"fw-normal","ms-1"],[1,"dropdown-menu","dropdown-menu-end"],["href","javascript:void(0);",1,"dropdown-item"],["class","alert alert-success alert-dismissible fade show","role","alert",4,"ngIf"],["class","alert alert-danger alert-dismissible fade show","role","alert",4,"ngIf"],["class","text-center py-5",4,"ngIf"],["class","alert alert-danger","role","alert",4,"ngIf"],["class","d-flex justify-content-end mb-3",4,"ngIf"],["class","treeview-container",4,"ngIf"],["role","alert",1,"alert","alert-success","alert-dismissible","fade","show"],[1,"isax","isax-tick-circle","me-2"],["type","button","data-bs-dismiss","alert","aria-label","Close",1,"btn-close",3,"click"],["role","alert",1,"alert","alert-danger","alert-dismissible","fade","show"],[1,"isax","isax-danger","me-2"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"],[1,"mt-2"],["role","alert",1,"alert","alert-danger"],["type","button",1,"btn","btn-sm","btn-outline-danger","ms-2",3,"click"],[1,"d-flex","justify-content-end","mb-3"],["type","button",1,"btn","btn-primary","d-inline-flex","align-items-center",3,"click","disabled"],["class","spinner-border spinner-border-sm me-1",4,"ngIf"],["class","isax isax-save-2 me-1",4,"ngIf"],[1,"spinner-border","spinner-border-sm","me-1"],[1,"isax","isax-save-2","me-1"],[1,"treeview-container"],[1,"treeview"],[4,"ngFor","ngForOf"],["class","treeview-item text-center py-5",4,"ngIf"],[1,"treeview-item"],[1,"treeview-header","d-flex","align-items-center","cursor-pointer",3,"click"],[1,"isax","isax-arrow-down-1","me-2","transition-icon"],[1,"fw-bold"],[1,"badge","bg-primary","rounded-pill","ms-2"],["class","treeview-submenu",4,"ngIf"],[1,"treeview-submenu"],["class","treeview-item text-center py-3",4,"ngIf"],[1,"treeview-header","d-flex","align-items-center"],[1,"d-flex","align-items-center","flex-grow-1","cursor-pointer",3,"click"],[1,"isax","isax-arrow-right-1","me-2","transition-icon"],[1,"fw-semibold"],[1,"form-check","m-0"],["type","checkbox",1,"form-check-input",3,"change","checked"],[1,"form-check-label","small","ms-1"],["class","treeview-item",4,"ngIf"],[1,"treeview-permissions"],[1,"treeview-permission-item"],[1,"form-check","d-flex","align-items-center"],["type","checkbox",1,"form-check-input","me-2",3,"change","id","checked"],[1,"form-check-label","flex-grow-1",3,"for"],["class","isax isax-info-circle ms-2 text-muted cursor-help",3,"title",4,"ngIf"],[1,"isax","isax-info-circle","ms-2","text-muted","cursor-help",3,"title"],[1,"treeview-item","text-center","py-3"],[1,"isax","isax-shield-slash","fs-24","text-muted","mb-2","d-block"],[1,"text-muted","mb-0","small"],[1,"treeview-item","text-center","py-5"],[1,"isax","isax-shield-slash","fs-48","text-muted","mb-3","d-block"],[1,"text-muted","mb-2"],[1,"text-muted","mb-0"]],template:function(e,n){e&1&&(o(0,"div",0)(1,"div",1)(2,"div")(3,"h6")(4,"a",2),P(5,"i",3),d(6),c(7,"translate"),a()()(),o(8,"div",4)(9,"div",5)(10,"a",6),d(11),c(12,"translate"),o(13,"span",7),d(14),c(15,"translate"),a()(),o(16,"ul",8)(17,"li")(18,"a",9),d(19),c(20,"translate"),a()()()()()(),f(21,ee,5,3,"div",10)(22,ie,4,1,"div",11)(23,te,7,3,"div",12)(24,ne,6,4,"div",13)(25,oe,7,8,"div",14)(26,Pe,4,2,"div",15),a()),e&2&&(s(4),l("routerLink",n.routes.rolePermissions),s(2),C(" ",u(7,12,"permissions.permissionManagement.title")," "),s(5),C(" ",u(12,14,"permissions.permissionManagement.role")," : "),s(3),v(n.roleNom||u(15,16,"permissions.permissionManagement.roleLoading")),s(5),V("",u(20,18,"permissions.permissionManagement.roleCode"),": ",n.roleCode),s(2),l("ngIf",n.saveSuccess),s(),l("ngIf",n.saveError),s(),l("ngIf",n.loading),s(),l("ngIf",n.error&&!n.loading),s(),l("ngIf",!n.loading&&!n.error),s(),l("ngIf",!n.loading&&!n.error))},dependencies:[j,$,F,H,L,Y],styles:[".treeview-container[_ngcontent-%COMP%]{padding:1rem;background-color:#f8f9fa;border-radius:8px}.treeview[_ngcontent-%COMP%]{list-style:none;padding-left:0;margin-bottom:0}.treeview-item[_ngcontent-%COMP%]{margin-bottom:.5rem}.treeview-header[_ngcontent-%COMP%]{padding:.75rem 1rem;background-color:#fff;border:1px solid #dee2e6;border-radius:6px;transition:all .2s ease}.treeview-header[_ngcontent-%COMP%]:hover{background-color:#f8f9fa;border-color:#0d6efd}.treeview-submenu[_ngcontent-%COMP%]{list-style:none;padding-left:1.5rem;margin-top:.5rem;margin-bottom:.5rem;border-left:2px solid #dee2e6}.treeview-action-header[_ngcontent-%COMP%]{padding:.5rem .75rem;background-color:#f8f9fa;border-radius:4px;margin-bottom:.5rem}.treeview-permissions[_ngcontent-%COMP%]{list-style:none;padding-left:1rem;margin-bottom:.5rem}.treeview-permission-item[_ngcontent-%COMP%]{padding:.5rem .75rem;background-color:#fff;border:1px solid #e9ecef;border-radius:4px;margin-bottom:.25rem}.treeview-permission-item[_ngcontent-%COMP%]:hover{background-color:#f8f9fa}.cursor-pointer[_ngcontent-%COMP%]{cursor:pointer}.cursor-help[_ngcontent-%COMP%]{cursor:help}.transition-icon[_ngcontent-%COMP%]{transition:transform .3s ease}.rotate-90[_ngcontent-%COMP%]{transform:rotate(90deg)}.rotate-90.isax-arrow-down-1[_ngcontent-%COMP%]{transform:rotate(180deg)}.form-check-input[_ngcontent-%COMP%]:checked{background-color:#0d6efd;border-color:#0d6efd}.badge[_ngcontent-%COMP%]{font-size:.75rem;padding:.25rem .5rem}"]})};export{Q as PermissionComponent};
