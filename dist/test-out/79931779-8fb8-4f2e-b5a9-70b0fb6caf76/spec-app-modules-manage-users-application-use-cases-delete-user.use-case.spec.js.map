{
  "version": 3,
  "sources": ["src/app/modules/manage-users/application/use-cases/delete-user.use-case.ts", "src/app/modules/manage-users/application/use-cases/delete-user.use-case.spec.ts"],
  "sourcesContent": ["import { Inject, Injectable, InjectionToken } from '@angular/core';\nimport { UserRepository, USER_REPOSITORY } from '../../domain/repositories/user.repository';\nimport { Result, DomainError, NotFoundError, BusinessRuleViolationError, InfrastructureError } from '../../../_shared';\n\n/**\n * Use Case: Delete User\n * \n * Permanently deletes a user account from the system.\n * This action cannot be undone.\n * \n * Business Rules:\n * - Cannot delete the currently logged-in user\n * - Cannot delete the last admin user\n * - User must exist\n * \n * @example\n * const result = await deleteUserUseCase.execute(userId, currentUserId);\n * if (result.isSuccess) {\n *   console.log('User deleted');\n * } else {\n *   console.error(result.error.message);\n * }\n */\nexport interface DeleteUserUseCase {\n    execute(userId: number, currentUserId: number): Promise<Result<void, DomainError>>;\n}\n\n@Injectable()\nexport class DeleteUserUseCaseImpl implements DeleteUserUseCase {\n    constructor(\n        @Inject(USER_REPOSITORY) private readonly userRepository: UserRepository\n    ) { }\n\n    async execute(userId: number, currentUserId: number): Promise<Result<void, DomainError>> {\n        try {\n            // Business Rule: Cannot delete yourself\n            if (userId === currentUserId) {\n                return Result.fail(\n                    new BusinessRuleViolationError('Vous ne pouvez pas supprimer votre propre compte')\n                );\n            }\n\n            // Check if user exists\n            const user = await this.userRepository.findById({ value: userId });\n\n            if (!user) {\n                return Result.fail(new NotFoundError('Utilisateur', userId));\n            }\n\n            // TODO: Add business rule to prevent deleting last admin\n            // This would require checking if user has admin role and counting other admins\n\n            // Delete the user\n            await this.userRepository.delete({ value: userId });\n\n            return Result.ok(undefined);\n        } catch (error) {\n            return Result.fail(\n                new InfrastructureError(\n                    `Erreur lors de la suppression de l'utilisateur: ${error instanceof Error ? error.message : 'Erreur inconnue'}`,\n                    error instanceof Error ? error : undefined\n                )\n            );\n        }\n    }\n}\n\n/**\n * Injection token for DeleteUserUseCase\n */\nexport const DELETE_USER_USE_CASE = new InjectionToken<DeleteUserUseCase>('DeleteUserUseCase');\n", "import { DeleteUserUseCaseImpl } from './delete-user.use-case';\nimport { UserRepository } from '../../domain/repositories/user.repository';\nimport { NotFoundError, DomainError, BusinessRuleViolationError } from '../../../_shared';\nimport { Result } from '../../../_shared/domain/types/result.type';\n\ndescribe('DeleteUserUseCase', () => {\n    let useCase: DeleteUserUseCaseImpl;\n    let mockRepository: jasmine.SpyObj<UserRepository>;\n\n    beforeEach(() => {\n        mockRepository = jasmine.createSpyObj('UserRepository', ['findById', 'delete', 'deleteUser']);\n        // deleteUser method might not exist in interface but was used in previous spec? \n        // Checking interface: delete(id) exists.\n        // I will use 'delete' in spy.\n        useCase = new DeleteUserUseCaseImpl(mockRepository);\n    });\n\n    describe('execute', () => {\n        it('should delete user successfully', async () => {\n            const userId = 2; // Different from currentUserId\n            const currentUserId = 1;\n            const mockUser = {\n                id: userId,\n                nomPrenom: 'John Doe'\n            };\n\n            mockRepository.findById.and.returnValue(Promise.resolve(mockUser as any));\n            mockRepository.delete.and.returnValue(Promise.resolve());\n\n            const result = await useCase.execute(userId, currentUserId);\n\n            expect(result.isSuccess).toBe(true);\n            expect(mockRepository.findById).toHaveBeenCalledWith(jasmine.objectContaining({ value: userId }));\n            expect(mockRepository.delete).toHaveBeenCalledWith(jasmine.objectContaining({ value: userId }));\n        });\n\n        it('should fail if deleting self', async () => {\n            const userId = 1;\n            const currentUserId = 1;\n\n            const result = await useCase.execute(userId, currentUserId);\n\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(BusinessRuleViolationError);\n            expect(mockRepository.delete).not.toHaveBeenCalled();\n        });\n\n        it('should fail when user not found', async () => {\n            const userId = 999;\n            const currentUserId = 1;\n            mockRepository.findById.and.returnValue(Promise.resolve(null));\n\n            const result = await useCase.execute(userId, currentUserId);\n\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(NotFoundError);\n            expect(mockRepository.delete).not.toHaveBeenCalled();\n        });\n    });\n});\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;IA4Ba,uBA0CA;;;;;AAtEb;AACA;AACA;AA0BO,IAAM,wBAAN,MAAMA,uBAAqB;MAEgB;MAD9C,YAC8C,gBAA8B;AAA9B,aAAA,iBAAA;MAC1C;MAEE,QAAQ,QAAgB,eAAqB;;AAC/C,cAAI;AAEA,gBAAI,WAAW,eAAe;AAC1B,qBAAO,OAAO,KACV,IAAI,2BAA2B,kDAAkD,CAAC;YAE1F;AAGA,kBAAM,OAAO,MAAM,KAAK,eAAe,SAAS,EAAE,OAAO,OAAM,CAAE;AAEjE,gBAAI,CAAC,MAAM;AACP,qBAAO,OAAO,KAAK,IAAI,cAAc,eAAe,MAAM,CAAC;YAC/D;AAMA,kBAAM,KAAK,eAAe,OAAO,EAAE,OAAO,OAAM,CAAE;AAElD,mBAAO,OAAO,GAAG,MAAS;UAC9B,SAAS,OAAO;AACZ,mBAAO,OAAO,KACV,IAAI,oBACA,mDAAmD,iBAAiB,QAAQ,MAAM,UAAU,iBAAiB,IAC7G,iBAAiB,QAAQ,QAAQ,MAAS,CAC7C;UAET;QACJ;;;6CAlCK,QAAM,MAAA,CAAC,eAAe,EAAA,CAAA,EAAA;;;AAFlB,4BAAqB,WAAA;MADjC,WAAU;OACE,qBAAqB;AA0C3B,IAAM,uBAAuB,IAAI,eAAkC,mBAAmB;;;;;ACtE7F;;;AAEA;AAGA,aAAS,qBAAqB,MAAK;AAC/B,UAAI;AACJ,UAAI;AAEJ,iBAAW,MAAK;AACZ,yBAAiB,QAAQ,aAAa,kBAAkB,CAAC,YAAY,UAAU,YAAY,CAAC;AAI5F,kBAAU,IAAI,sBAAsB,cAAc;MACtD,CAAC;AAED,eAAS,WAAW,MAAK;AACrB,WAAG,mCAAmC,MAAW;AAC7C,gBAAM,SAAS;AACf,gBAAM,gBAAgB;AACtB,gBAAM,WAAW;YACb,IAAI;YACJ,WAAW;;AAGf,yBAAe,SAAS,IAAI,YAAY,QAAQ,QAAQ,QAAe,CAAC;AACxE,yBAAe,OAAO,IAAI,YAAY,QAAQ,QAAO,CAAE;AAEvD,gBAAM,SAAS,MAAM,QAAQ,QAAQ,QAAQ,aAAa;AAE1D,iBAAO,OAAO,SAAS,EAAE,KAAK,IAAI;AAClC,iBAAO,eAAe,QAAQ,EAAE,qBAAqB,QAAQ,iBAAiB,EAAE,OAAO,OAAM,CAAE,CAAC;AAChG,iBAAO,eAAe,MAAM,EAAE,qBAAqB,QAAQ,iBAAiB,EAAE,OAAO,OAAM,CAAE,CAAC;QAClG,EAAC;AAED,WAAG,gCAAgC,MAAW;AAC1C,gBAAM,SAAS;AACf,gBAAM,gBAAgB;AAEtB,gBAAM,SAAS,MAAM,QAAQ,QAAQ,QAAQ,aAAa;AAE1D,iBAAO,OAAO,SAAS,EAAE,KAAK,IAAI;AAClC,iBAAO,OAAO,KAAK,EAAE,eAAe,0BAA0B;AAC9D,iBAAO,eAAe,MAAM,EAAE,IAAI,iBAAgB;QACtD,EAAC;AAED,WAAG,mCAAmC,MAAW;AAC7C,gBAAM,SAAS;AACf,gBAAM,gBAAgB;AACtB,yBAAe,SAAS,IAAI,YAAY,QAAQ,QAAQ,IAAI,CAAC;AAE7D,gBAAM,SAAS,MAAM,QAAQ,QAAQ,QAAQ,aAAa;AAE1D,iBAAO,OAAO,SAAS,EAAE,KAAK,IAAI;AAClC,iBAAO,OAAO,KAAK,EAAE,eAAe,aAAa;AACjD,iBAAO,eAAe,MAAM,EAAE,IAAI,iBAAgB;QACtD,EAAC;MACL,CAAC;IACL,CAAC;;;",
  "names": ["DeleteUserUseCaseImpl"]
}
