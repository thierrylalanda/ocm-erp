{
  "version": 3,
  "sources": ["src/app/modules/_shared/application/ports/application-context.port.ts", "src/app/modules/stock/application/use-cases/movements/create-stock-movement.use-case.impl.ts", "src/app/modules/stock/domain/entities/stock-movement.entity.ts", "src/app/modules/stock/application/use-cases/movements/create-stock-movement.use-case.spec.ts"],
  "sourcesContent": ["import { InjectionToken } from '@angular/core';\n\n/**\n * Application Context Port (Interface)\n * \n * Provides access to application-wide context information like:\n * - Current user\n * - Current company (société)\n * - Authentication state\n * \n * This is a port (interface) in Clean Architecture terms.\n * The actual implementation (adapter) can use localStorage, sessionStorage,\n * or any other mechanism.\n * \n * Benefits:\n * - Decouples repositories from storage mechanism\n * - Easy to test (mock the context)\n * - Easy to change storage implementation\n * - Single source of truth for context data\n * \n * @example\n * // In repository\n * constructor(\n *   @Inject(APPLICATION_CONTEXT) private context: ApplicationContext\n * ) {}\n * \n * async findAll(): Promise<User[]> {\n *   const societeId = this.context.getSocieteId();\n *   return this.http.get(`/users?societeId=${societeId}`);\n * }\n */\nexport interface ApplicationContext {\n    /**\n     * Get the current société (company) ID\n     */\n    getSocieteId(): number;\n\n    /**\n     * Get the current user ID\n     */\n    getUserId(): number;\n\n    /**\n     * Get the current site ID (if applicable)\n     */\n    getSiteId(): number | null;\n\n    /**\n     * Get the current département ID (if applicable)\n     */\n    getDepartementId(): number | null;\n\n    /**\n     * Get the authentication token\n     */\n    getToken(): string | null;\n\n    /**\n     * Check if user is authenticated\n     */\n    isAuthenticated(): boolean;\n\n    /**\n     * Get user permissions\n     */\n    getPermissions(): string[];\n\n    /**\n     * Check if user has a specific permission\n     */\n    hasPermission(permission: string): boolean;\n\n    /**\n     * Get user roles\n     */\n    getRoles(): string[];\n\n    /**\n     * Check if user has a specific role\n     */\n    hasRole(role: string): boolean;\n\n    /**\n     * Get user language preference\n     */\n    getLanguage(): string;\n\n    /**\n     * Set société ID\n     */\n    setSocieteId(id: number): void;\n\n    /**\n     * Set user ID\n     */\n    setUserId(id: number): void;\n\n    /**\n     * Set authentication token\n     */\n    setToken(token: string): void;\n\n    /**\n     * Clear all context data (logout)\n     */\n    clear(): void;\n}\n\n/**\n * Injection token for ApplicationContext\n */\nexport const APPLICATION_CONTEXT = new InjectionToken<ApplicationContext>('ApplicationContext');\n", "import { Inject, Injectable } from '@angular/core';\nimport { CreateStockMovementUseCase } from './create-stock-movement.use-case';\nimport { StockRepository, STOCK_REPOSITORY } from '../../../domain/repositories/stock.repository';\nimport { Result } from '../../../../_shared/domain/types/result.type';\nimport { DomainError, UnauthorizedError } from '../../../../_shared/domain/errors/domain.error';\nimport { ApplicationContext, APPLICATION_CONTEXT } from '../../../../_shared/application/ports/application-context.port';\nimport { CreateStockMovementDto, StockMovementDto } from '../../dto/stock.dto';\n\n/**\n * Implémentation du use case CreateStockMovement\n */\n@Injectable()\nexport class CreateStockMovementUseCaseImpl implements CreateStockMovementUseCase {\n    constructor(\n        @Inject(STOCK_REPOSITORY) private stockRepository: StockRepository,\n        @Inject(APPLICATION_CONTEXT) private context: ApplicationContext\n    ) { }\n\n    async execute(dto: CreateStockMovementDto): Promise<Result<StockMovementDto, DomainError>> {\n        if (!this.context.isAuthenticated()) {\n            return Result.fail(new UnauthorizedError('create stock movement'));\n        }\n\n        const userId = this.context.getUserId();\n\n        const movement = {\n            type: dto.type,\n            productId: dto.productId,\n            quantity: dto.quantity,\n            warehouseId: dto.warehouseId,\n            destinationWarehouseId: dto.destinationWarehouseId,\n            documentReference: dto.documentReference,\n            lotNumber: dto.lotNumber,\n            serialNumber: dto.serialNumber,\n            unitCost: dto.unitCost,\n            reason: dto.reason,\n            notes: dto.notes,\n            movementDate: dto.movementDate || new Date(),\n            createdBy: userId ? userId.toString() : 'system',\n            isValidated: false\n        };\n\n        const result = await this.stockRepository.createMovement(movement);\n\n        if (result.isFailure) {\n            return Result.fail(result.error);\n        }\n\n        const createdMovement = result.value;\n\n        return Result.ok({\n            id: createdMovement.id,\n            type: createdMovement.type,\n            productId: createdMovement.productId,\n            quantity: createdMovement.quantity,\n            warehouseId: createdMovement.warehouseId,\n            destinationWarehouseId: createdMovement.destinationWarehouseId,\n            documentReference: createdMovement.documentReference,\n            lotNumber: createdMovement.lotNumber,\n            serialNumber: createdMovement.serialNumber,\n            unitCost: createdMovement.unitCost,\n            reason: createdMovement.reason,\n            notes: createdMovement.notes,\n            movementDate: createdMovement.movementDate,\n            createdAt: createdMovement.createdAt,\n            createdBy: createdMovement.createdBy,\n            isValidated: createdMovement.isValidated,\n            validatedAt: createdMovement.validatedAt,\n            validatedBy: createdMovement.validatedBy\n        });\n    }\n}\n", "/**\n * Type de mouvement de stock\n */\nexport enum StockMovementType {\n    /** Entrée (réception, achat) */\n    ENTRY = 'ENTRY',\n\n    /** Sortie (vente, consommation) */\n    EXIT = 'EXIT',\n\n    /** Transfert entre magasins */\n    TRANSFER = 'TRANSFER',\n\n    /** Ajustement (inventaire) */\n    ADJUSTMENT = 'ADJUSTMENT',\n\n    /** Retour */\n    RETURN = 'RETURN'\n}\n\n/**\n * Entité StockMovement - Mouvement de stock\n */\nexport interface StockMovement {\n    /** ID unique */\n    id: string;\n\n    /** Type de mouvement */\n    type: StockMovementType;\n\n    /** Produit concerné */\n    productId: string;\n\n    /** Quantité */\n    quantity: number;\n\n    /** Magasin source */\n    warehouseId: string;\n\n    /** Magasin destination (pour transfert) */\n    destinationWarehouseId?: string;\n\n    /** Référence du document (bon de commande, facture, etc.) */\n    documentReference?: string;\n\n    /** Numéro de lot */\n    lotNumber?: string;\n\n    /** Numéro de série */\n    serialNumber?: string;\n\n    /** Coût unitaire */\n    unitCost?: number;\n\n    /** Raison du mouvement */\n    reason?: string;\n\n    /** Notes */\n    notes?: string;\n\n    /** Date du mouvement */\n    movementDate: Date;\n\n    /** Date de création */\n    createdAt: Date;\n\n    /** Créé par */\n    createdBy: string;\n\n    /** Validé */\n    isValidated: boolean;\n\n    /** Date de validation */\n    validatedAt?: Date;\n\n    /** Validé par */\n    validatedBy?: string;\n}\n", "import { TestBed } from '@angular/core/testing';\nimport { CreateStockMovementUseCaseImpl } from './create-stock-movement.use-case.impl';\nimport { STOCK_REPOSITORY, StockRepository } from '../../../domain/repositories/stock.repository';\nimport { APPLICATION_CONTEXT, ApplicationContext } from '../../../../_shared/application/ports/application-context.port';\nimport { Result } from '../../../../_shared/domain/types/result.type';\nimport { CreateStockMovementDto } from '../../dto/stock.dto';\nimport { StockMovement, StockMovementType } from '../../../domain/entities/stock-movement.entity';\nimport { UnauthorizedError } from '../../../../_shared/domain/errors/domain.error';\n\ndescribe('CreateStockMovementUseCaseImpl', () => {\n    let useCase: CreateStockMovementUseCaseImpl;\n    let mockStockRepository: jasmine.SpyObj<StockRepository>;\n    let mockApplicationContext: jasmine.SpyObj<ApplicationContext>;\n\n    beforeEach(() => {\n        mockStockRepository = jasmine.createSpyObj('StockRepository', ['createMovement']);\n        mockApplicationContext = jasmine.createSpyObj('ApplicationContext', ['isAuthenticated', 'getUserId']);\n\n        TestBed.configureTestingModule({\n            providers: [\n                CreateStockMovementUseCaseImpl,\n                { provide: STOCK_REPOSITORY, useValue: mockStockRepository },\n                { provide: APPLICATION_CONTEXT, useValue: mockApplicationContext }\n            ]\n        });\n\n        useCase = TestBed.inject(CreateStockMovementUseCaseImpl);\n    });\n\n    it('should be created', () => {\n        expect(useCase).toBeTruthy();\n    });\n\n    it('should return error if user is not authenticated', async () => {\n        mockApplicationContext.isAuthenticated.and.returnValue(false);\n        const dto: CreateStockMovementDto = {\n            productId: '1',\n            warehouseId: '1',\n            quantity: 10,\n            type: StockMovementType.ENTRY\n        };\n\n        const result = await useCase.execute(dto);\n\n        expect(result.isFailure).toBeTrue();\n        expect(result.error).toBeInstanceOf(UnauthorizedError);\n        expect(mockStockRepository.createMovement).not.toHaveBeenCalled();\n    });\n\n    it('should create movement successfully when authenticated', async () => {\n        mockApplicationContext.isAuthenticated.and.returnValue(true);\n        mockApplicationContext.getUserId.and.returnValue(123);\n        const date = new Date();\n\n        const dto: CreateStockMovementDto = {\n            productId: 'prod1',\n            warehouseId: 'wh1',\n            quantity: 10,\n            type: StockMovementType.ENTRY,\n            reason: 'Test'\n        };\n\n        const createdMovement: StockMovement = {\n            id: 'mov1',\n            ...dto,\n            movementDate: date,\n            createdAt: date,\n            createdBy: '123',\n            isValidated: false\n        };\n\n        mockStockRepository.createMovement.and.returnValue(Promise.resolve(Result.ok(createdMovement)));\n\n        const result = await useCase.execute(dto);\n\n        expect(result.isSuccess).toBeTrue();\n        expect(result.value.id).toBe('mov1');\n        expect(result.value.createdBy).toBe('123');\n        expect(mockStockRepository.createMovement).toHaveBeenCalledWith(jasmine.objectContaining({\n            productId: 'prod1',\n            createdBy: '123'\n        }));\n    });\n});\n"],
  "mappings": "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",
  "names": ["CreateStockMovementUseCaseImpl", "StockMovementType"]
}
