{
  "version": 3,
  "sources": ["src/app/modules/setting/application/use-cases/create-site.use-case.ts", "src/app/modules/setting/application/use-cases/create-site.use-case.spec.ts"],
  "sourcesContent": ["import { Injectable, Inject } from '@angular/core';\nimport { Result, DomainError, ValidationError, AlreadyExistsError, InfrastructureError, APPLICATION_CONTEXT, ApplicationContext } from '../../../_shared';\nimport { CreateSiteDto, SiteResponseDto } from '../../domain/dto/site.dto';\nimport { SiteService } from '../services/site.service';\n\n/**\n * Interface du Use Case CreateSite\n */\nexport interface CreateSiteUseCase {\n    execute(dto: CreateSiteDto): Promise<Result<SiteResponseDto, DomainError>>;\n}\n\n/**\n * Token d'injection pour CreateSiteUseCase\n */\nexport const CREATE_SITE_USE_CASE = 'CREATE_SITE_USE_CASE';\n\n/**\n * Implémentation du Use Case CreateSite\n * \n * Responsabilités:\n * - Valider les données du site\n * - Vérifier que le code n'existe pas déjà\n * - Créer le site via le service\n * - Retourner un Result avec le site créé ou une erreur\n */\n@Injectable()\nexport class CreateSiteUseCaseImpl implements CreateSiteUseCase {\n    constructor(\n        private siteService: SiteService,\n        @Inject(APPLICATION_CONTEXT) private context: ApplicationContext\n    ) { }\n\n    async execute(dto: CreateSiteDto): Promise<Result<SiteResponseDto, DomainError>> {\n        try {\n            // 1. Validation des données\n            if (!dto.nom || dto.nom.trim().length === 0) {\n                return Result.fail(\n                    new ValidationError('Le nom du site est requis')\n                );\n            }\n\n            if (!dto.code || dto.code.trim().length === 0) {\n                return Result.fail(\n                    new ValidationError('Le code du site est requis')\n                );\n            }\n\n            // 2. Récupérer la société depuis le contexte\n            const societeId = this.context.getSocieteId();\n            if (!societeId) {\n                return Result.fail(\n                    new ValidationError('Société non trouvée dans le contexte')\n                );\n            }\n\n            // 3. Vérifier si le code existe déjà\n            const codeAvailable = await this.siteService\n                .checkCodeAvailability(dto.code, societeId)\n                .toPromise();\n\n            if (!codeAvailable) {\n                return Result.fail(\n                    new AlreadyExistsError('Site', 'code', dto.code)\n                );\n            }\n\n            // 4. Créer le site\n            const site = await this.siteService.createSite({\n                ...dto,\n                societeId\n            }).toPromise();\n\n            if (!site) {\n                return Result.fail(\n                    new InfrastructureError('Erreur lors de la création du site')\n                );\n            }\n\n            // 5. Retourner le résultat\n            return Result.ok(site);\n\n        } catch (error: any) {\n            // Gestion des erreurs inattendues\n            console.error('CreateSiteUseCase error:', error);\n\n            return Result.fail(\n                new InfrastructureError(\n                    error.message || 'Erreur lors de la création du site'\n                )\n            );\n        }\n    }\n}\n", "import { CreateSiteUseCaseImpl, CREATE_SITE_USE_CASE } from './create-site.use-case';\nimport { SiteService } from '../services/site.service';\nimport { ApplicationContext } from '../../../_shared';\nimport { ValidationError, AlreadyExistsError, InfrastructureError } from '../../../_shared';\nimport { of, throwError } from 'rxjs';\n\ndescribe('CreateSiteUseCase', () => {\n    let useCase: CreateSiteUseCaseImpl;\n    let mockSiteService: any;\n    let mockContext: any;\n\n    beforeEach(() => {\n        // Create mock site service\n        mockSiteService = {\n            checkCodeAvailability: jasmine.createSpy('checkCodeAvailability'),\n            createSite: jasmine.createSpy('createSite')\n        };\n\n        // Create mock application context\n        mockContext = {\n            getSocieteId: jasmine.createSpy('getSocieteId').and.returnValue(1),\n            getSocieteNom: jasmine.createSpy('getSocieteNom').and.returnValue('Test Company'),\n            getUserId: jasmine.createSpy('getUserId').and.returnValue(1),\n            getUserName: jasmine.createSpy('getUserName').and.returnValue('testuser'),\n            getSiteId: jasmine.createSpy('getSiteId').and.returnValue(null),\n            getDepartementId: jasmine.createSpy('getDepartementId').and.returnValue(null),\n            getUser: jasmine.createSpy('getUser').and.returnValue(null),\n            isAuthenticated: jasmine.createSpy('isAuthenticated').and.returnValue(true)\n        };\n\n        useCase = new CreateSiteUseCaseImpl(mockSiteService, mockContext);\n    });\n\n    describe('execute', () => {\n        it('should create site successfully', async () => {\n            // Arrange\n            const dto = {\n                nom: 'Site Test',\n                code: 'ST001',\n                type: 'SIEGE' as const,\n                ville: 'Test City',\n                pays: 'Test Country',\n                societeId: 1,\n                actif: true\n            };\n\n            const expectedSite = {\n                id: 1,\n                nom: 'Site Test',\n                code: 'ST001',\n                type: 'SIEGE' as const,\n                ville: 'Test City',\n                pays: 'Test Country',\n                societeId: 1,\n                societeNom: 'Test Company',\n                actif: true,\n                dateCreation: '2024-01-01T00:00:00Z'\n            };\n\n            mockSiteService.checkCodeAvailability.and.returnValue(of(true));\n            mockSiteService.createSite.and.returnValue(of(expectedSite));\n\n            // Act\n            const result = await useCase.execute(dto);\n\n            // Assert\n            expect(result.isSuccess).toBe(true);\n            expect(mockSiteService.checkCodeAvailability).toHaveBeenCalledWith('ST001', 1);\n            expect(mockSiteService.createSite).toHaveBeenCalledWith(dto);\n        });\n\n        it('should fail when nom is empty', async () => {\n            // Arrange\n            const dto = {\n                nom: '',\n                code: 'ST001',\n                type: 'SIEGE'\n            };\n\n            // Act\n            const result = await useCase.execute(dto as any);\n\n            // Assert\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(ValidationError);\n            expect(result.error.message).toContain('nom');\n            expect(mockSiteService.createSite).not.toHaveBeenCalled();\n        });\n\n        it('should fail when code is empty', async () => {\n            // Arrange\n            const dto = {\n                nom: 'Site Test',\n                code: '',\n                type: 'SIEGE'\n            };\n\n            // Act\n            const result = await useCase.execute(dto as any);\n\n            // Assert\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(ValidationError);\n            expect(result.error.message).toContain('code');\n            expect(mockSiteService.createSite).not.toHaveBeenCalled();\n        });\n\n        it('should fail when societeId is not in context', async () => {\n            // Arrange\n            mockContext.getSocieteId.and.returnValue(0);\n            const dto = {\n                nom: 'Site Test',\n                code: 'ST001',\n                type: 'SIEGE'\n            };\n\n            // Act\n            const result = await useCase.execute(dto as any);\n\n            // Assert\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(ValidationError);\n            expect(result.error.message).toContain('Société');\n            expect(mockSiteService.createSite).not.toHaveBeenCalled();\n        });\n\n        it('should fail when code already exists', async () => {\n            // Arrange\n            const dto = {\n                nom: 'Site Test',\n                code: 'ST001',\n                type: 'SIEGE'\n            };\n\n            mockSiteService.checkCodeAvailability.and.returnValue(of(false));\n\n            // Act\n            const result = await useCase.execute(dto as any);\n\n            // Assert\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(AlreadyExistsError);\n            expect(result.error.message).toContain('ST001');\n            expect(mockSiteService.createSite).not.toHaveBeenCalled();\n        });\n\n        it('should handle service errors', async () => {\n            // Arrange\n            const dto = {\n                nom: 'Site Test',\n                code: 'ST001',\n                type: 'SIEGE'\n            };\n\n            mockSiteService.checkCodeAvailability.and.returnValue(of(true));\n            mockSiteService.createSite.and.returnValue(\n                throwError(() => new Error('Database error'))\n            );\n\n            // Act\n            const result = await useCase.execute(dto as any);\n\n            // Assert\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(InfrastructureError);\n        });\n\n        it('should handle null response from service', async () => {\n            // Arrange\n            const dto = {\n                nom: 'Site Test',\n                code: 'ST001',\n                type: 'SIEGE'\n            };\n\n            mockSiteService.checkCodeAvailability.and.returnValue(of(true));\n            mockSiteService.createSite.and.returnValue(of(null));\n\n            // Act\n            const result = await useCase.execute(dto as any);\n\n            // Assert\n            expect(result.isFailure).toBe(true);\n            expect(result.error).toBeInstanceOf(InfrastructureError);\n        });\n    });\n});\n"],
  "mappings": "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",
  "names": ["CreateSiteUseCaseImpl"]
}
