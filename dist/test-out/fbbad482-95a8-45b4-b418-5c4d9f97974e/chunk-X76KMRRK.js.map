{
  "version": 3,
  "sources": ["src/app/modules/setting/application/services/site.service.ts"],
  "sourcesContent": ["import { Injectable } from '@angular/core';\nimport { HttpClient, HttpParams, HttpErrorResponse } from '@angular/common/http';\nimport { Observable, throwError, of } from 'rxjs';\nimport { catchError, map } from 'rxjs/operators';\nimport { environment } from '../../../../../environments/environment';\nimport {\n  CreateSiteDto,\n  UpdateSiteDto,\n  SiteResponseDto,\n  PagedSiteResponse\n} from '../../domain/dto/site.dto';\nimport { AuthService } from '../../../../core/services/auth/auth.service';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class SiteService {\n  private apiUrl = `${environment.api}hierarchie/sites`;\n\n  constructor(\n    private http: HttpClient,\n    private authService: AuthService\n  ) {}\n\n  /**\n   * Récupère la liste paginée des sites\n   * @param params Paramètres de pagination et filtrage\n   */\n  getSites(params: {\n    page?: number;\n    size?: number;\n    societeId?: number;\n    type?: string;\n    actif?: boolean;\n    ville?: string;\n    pays?: string;\n  }): Observable<PagedSiteResponse> {\n    let httpParams = new HttpParams();\n    \n    if (params.page !== undefined) {\n      httpParams = httpParams.set('page', params.page.toString());\n    }\n    if (params.size !== undefined) {\n      httpParams = httpParams.set('size', params.size.toString());\n    }\n    if (params.societeId !== undefined) {\n      httpParams = httpParams.set('societeId', params.societeId.toString());\n    }\n    if (params.type) {\n      httpParams = httpParams.set('type', params.type);\n    }\n    if (params.actif !== undefined) {\n      httpParams = httpParams.set('actif', params.actif.toString());\n    }\n    if (params.ville) {\n      httpParams = httpParams.set('ville', params.ville);\n    }\n    if (params.pays) {\n      httpParams = httpParams.set('pays', params.pays);\n    }\n\n    return this.http.get<PagedSiteResponse>(this.apiUrl, { params: httpParams })\n      .pipe(\n        catchError(error => this.handleError(error, 'Erreur lors de la récupération des sites'))\n      );\n  }\n\n  /**\n   * Récupère un site par son ID\n   * @param id Identifiant du site\n   */\n  getSite(id: number): Observable<SiteResponseDto> {\n    return this.http.get<SiteResponseDto>(`${this.apiUrl}/${id}`)\n      .pipe(\n        catchError(error => this.handleError(error, 'Site non trouvé'))\n      );\n  }\n\n  /**\n   * Crée un nouveau site\n   * @param site Données du site à créer\n   */\n  createSite(site: CreateSiteDto): Observable<SiteResponseDto> {\n    return this.http.post<SiteResponseDto>(this.apiUrl, site)\n      .pipe(\n        catchError(error => this.handleError(error, 'Erreur lors de la création du site'))\n      );\n  }\n\n  /**\n   * Met à jour un site existant\n   * @param id Identifiant du site\n   * @param site Données du site à mettre à jour\n   */\n  updateSite(id: number, site: UpdateSiteDto): Observable<SiteResponseDto> {\n    return this.http.put<SiteResponseDto>(`${this.apiUrl}/${id}`, site)\n      .pipe(\n        catchError(error => this.handleError(error, 'Erreur lors de la mise à jour du site'))\n      );\n  }\n\n  /**\n   * Supprime un site\n   * @param id Identifiant du site\n   */\n  deleteSite(id: number): Observable<void> {\n    return this.http.delete<void>(`${this.apiUrl}/${id}`)\n      .pipe(\n        catchError(error => this.handleError(error, 'Erreur lors de la suppression du site'))\n      );\n  }\n\n  /**\n   * Active ou désactive un site\n   * @param id Identifiant du site\n   * @param actif Statut actif/inactif\n   */\n  toggleSiteStatus(id: number, actif: boolean): Observable<SiteResponseDto> {\n    return this.http.patch<SiteResponseDto>(`${this.apiUrl}/${id}/status`, { actif })\n      .pipe(\n        catchError(error => this.handleError(error, 'Erreur lors du changement de statut'))\n      );\n  }\n\n  /**\n   * Récupère la société de l'utilisateur connecté\n   */\n  getCurrentUserSocieteId(): number | null {\n    const user = this.authService.user;\n    return user?.societeId || null;\n  }\n\n  /**\n   * Gestion des erreurs HTTP\n   * @param error Erreur HTTP\n   * @param defaultMessage Message par défaut\n   */\n  private handleError(error: HttpErrorResponse, defaultMessage: string): Observable<never> {\n    let errorMessage = defaultMessage;\n\n    if (error.error instanceof ErrorEvent) {\n      // Erreur côté client\n      errorMessage = `Erreur: ${error.error.message}`;\n    } else {\n      // Erreur côté serveur\n      switch (error.status) {\n        case 400:\n          errorMessage = 'Données invalides. Vérifiez les champs du formulaire.';\n          if (error.error?.message) {\n            errorMessage += ` ${error.error.message}`;\n          }\n          break;\n        case 401:\n          errorMessage = 'Non autorisé. Veuillez vous reconnecter.';\n          break;\n        case 403:\n          errorMessage = 'Accès interdit. Vous n\\'avez pas les permissions nécessaires.';\n          break;\n        case 404:\n          errorMessage = 'Site non trouvé.';\n          break;\n        case 409:\n          errorMessage = 'Un site avec ce code existe déjà pour cette société.';\n          break;\n        case 500:\n          errorMessage = 'Erreur serveur. Veuillez réessayer plus tard.';\n          break;\n        case 503:\n          errorMessage = 'Service temporairement indisponible. Veuillez réessayer.';\n          break;\n        default:\n          errorMessage = `${defaultMessage} (Code: ${error.status})`;\n          if (error.error?.message) {\n            errorMessage += ` - ${error.error.message}`;\n          }\n      }\n    }\n\n    console.error('Site Service Error:', {\n      status: error.status,\n      message: errorMessage,\n      error: error.error\n    });\n\n    return throwError(() => new Error(errorMessage));\n  }\n\n  /**\n   * Vérifie si un code de site est disponible\n   * @param code Code à vérifier\n   * @param societeId ID de la société\n   * @param excludeSiteId ID du site à exclure (lors de la mise à jour)\n   */\n  checkCodeAvailability(code: string, societeId: number, excludeSiteId?: number): Observable<boolean> {\n    let httpParams = new HttpParams()\n      .set('code', code)\n      .set('societeId', societeId.toString());\n    \n    if (excludeSiteId) {\n      httpParams = httpParams.set('excludeId', excludeSiteId.toString());\n    }\n\n    return this.http.get<{ available: boolean }>(`${this.apiUrl}/check-code`, { params: httpParams })\n      .pipe(\n        map(response => response.available),\n        catchError(() => of(true)) // En cas d'erreur, on considère que le code est disponible\n      );\n  }\n\n  /**\n   * Exporte les sites en CSV\n   * @param params Paramètres de filtrage\n   */\n  exportSitesToCsv(params: {\n    societeId?: number;\n    type?: string;\n    actif?: boolean;\n  }): Observable<Blob> {\n    let httpParams = new HttpParams();\n    \n    if (params.societeId !== undefined) {\n      httpParams = httpParams.set('societeId', params.societeId.toString());\n    }\n    if (params.type) {\n      httpParams = httpParams.set('type', params.type);\n    }\n    if (params.actif !== undefined) {\n      httpParams = httpParams.set('actif', params.actif.toString());\n    }\n\n    return this.http.get(`${this.apiUrl}/export/csv`, {\n      params: httpParams,\n      responseType: 'blob'\n    }).pipe(\n      catchError(error => this.handleError(error, 'Erreur lors de l\\'export'))\n    );\n  }\n\n  /**\n   * Récupère les statistiques des sites\n   * @param societeId ID de la société\n   */\n  getSiteStatistics(societeId: number): Observable<{\n    total: number;\n    actifs: number;\n    inactifs: number;\n    parType: Record<string, number>;\n    parVille: Record<string, number>;\n    parPays: Record<string, number>;\n  }> {\n    const params = new HttpParams().set('societeId', societeId.toString());\n    \n    return this.http.get<any>(`${this.apiUrl}/statistics`, { params })\n      .pipe(\n        catchError(() => of({\n          total: 0,\n          actifs: 0,\n          inactifs: 0,\n          parType: {},\n          parVille: {},\n          parPays: {}\n        }))\n      );\n  }\n}\n"],
  "mappings": "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",
  "names": ["SiteService"]
}
